<!doctype html>
<html lang="ja">

<head>
  <title>Socket.IO chat</title>
</head>

<body>
  <pre id="out"></pre>
  <input type="text" id="msg">
  <input type="button" id="btn" value="OK">

  <div>同時接続数:<span id="cnt"></span></div>

  <div>
    <input type="button" id="rec" value="rec">
    <div>
      <video id="video" width="100" height="100"></video>
      <video id="video2"></video>
    </div>
  </div>
  <img id="videoout">
  <canvas id="canvas" width="100" height="100"></canvas>

  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script>
    const video = document.getElementById("video")
    document.getElementById('rec').addEventListener('click', () => {
      // navigator.mediaDevices.getUserMedia('video', startCapture_, error_);

      navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false,
      }).then((stream) => {
        // console.log(stream);
        video.srcObject = stream;
        video.play();
        startCapture_(stream);

      }).catch(e => {
        console.log(e)
      });
    });

    function startCapture_(stream) {
      // video要素に対して、カメラからのストリームを設定
      // video.src = stream;

      // 30fpsでJPEG画像を取得
      timer = setInterval(function () {
        try {
          // キャンバスノードの生成
          // var cvs = document.createElement('canvas');
          var cvs = document.getElementById('canvas');
          cvs.width = video.width;
          cvs.height = video.height;
          var ctx = cvs.getContext('2d');

          // キャンバスに描画
          ctx.drawImage(video, 0, 0, 480, 640, 0, 0, video.width, video.height);

          // DataURLを取得し、イベントを発行する
          var data = cvs.toDataURL('image/jpeg');
          // console.log(data);
          $(window).trigger("imageupdate", data);
        } catch (e) {
          // エラー時
          error_(e);
        }
      }, 33);
    }
    $(window).bind("imageupdate", function (e, data) {
      // カメラ画像をWebSocketで送信する
      socket.emit("stream", data);
    });
    function error_(e) {
      console.error(e);
    }
  </script>

  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"
    integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H"
    crossorigin="anonymous"></script>
  <script>
    var out = document.getElementById("out");
    var msg = document.getElementById("msg");
    var btn = document.getElementById("btn");
    var cnt = document.getElementById("cnt");
    var socket = io();
    btn.addEventListener("click", (e) => {
      socket.emit("post_message", msg.value);
    });
    socket.on("recv_message", (message) => {
      out.innerText += message + "\n";
      msg.value = "";
      msg.focus();
    });
    socket.on('count', count => {
      cnt.innerText = count;
    });

    socket.on('stream', (stream) => {
      // console.log(stream);
      document.getElementById('videoout').src = stream;
    });
  </script>
</body>

</html>