<!doctype html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>idöbätä</title>
  <link href="https://cdn.jsdelivr.net/npm/beercss@2.2.11/dist/cdn/beer.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/beercss@2.2.11/dist/cdn/beer.min.js" type="text/javascript"></script>
</head>

<body>
  <main class="responsive">
    <header>
      <nav>
        <h5 class="max">idöbätä</h5>
      </nav>
    </header>

    <div class="grid no-space">
      <div class="s6">
        <div>同時接続数:<span id="cnt"></span></div>

        <button id="rec">REC</button>

        <div class="grid no-space">
          <div class="s6">
            <article class="no-padding">
              <video id="video" class="responsive medium">
                <!-- <source src="/dance.mp4" type="video/mp4"> -->
              </video>
            </article>
          </div>
          <div class="s6">
            <article class="no-padding">
              <img id="videoout" class="responsive medium">
            </article>
          </div>
        </div>


        <canvas id="canvas" class="round extra" width="480" height="480" style="display:none"></canvas>
      </div>
      <div class="s6">
        <pre id="out"></pre>
        <div class="field border">
          <input id="msg" type="text">
        </div>
        <button id="btn">OK</button>
      </div>
  </main>

  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@0.0.10/dist/cdn/material-dynamic-colors.min.js"
    type="text/javascript"></script>
  <script>
    const video = document.getElementById("video")
    document.getElementById('rec').addEventListener('click', () => {
      // navigator.mediaDevices.getUserMedia('video', startCapture_, error_);

      navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false,
      }).then((stream) => {
        // console.log(stream);
        video.srcObject = stream;
        video.play();
        startCapture_(stream);

      }).catch(e => {
        console.log(e)
      });
    });

    function startCapture_(stream) {
      // video要素に対して、カメラからのストリームを設定
      // video.src = stream;

      // 30fpsでJPEG画像を取得
      timer = setInterval(function () {
        try {
          // キャンバスノードの生成
          // var cvs = document.createElement('canvas');
          var cvs = document.getElementById('canvas');
          // cvs.width = video.width;
          // cvs.height = video.height;
          var ctx = cvs.getContext('2d');

          // キャンバスに描画
          ctx.drawImage(video, 0, 0, 480, 480, 0, 0, cvs.width, cvs.height);

          // DataURLを取得し、イベントを発行する
          var data = cvs.toDataURL('image/jpeg');
          // console.log(data);
          $(window).trigger("imageupdate", data);
        } catch (e) {
          // エラー時
          error_(e);
        }
      }, 33);
    }
    $(window).bind("imageupdate", function (e, data) {
      // カメラ画像をWebSocketで送信する
      socket.emit("stream", data);
    });
    function error_(e) {
      console.error(e);
    }
  </script>

  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"
    integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H"
    crossorigin="anonymous"></script>
  <script>
    var out = document.getElementById("out");
    var msg = document.getElementById("msg");
    var btn = document.getElementById("btn");
    var cnt = document.getElementById("cnt");
    var socket = io();
    btn.addEventListener("click", (e) => {
      socket.emit("post_message", msg.value);
    });
    socket.on("recv_message", (message) => {
      out.innerText += message + "\n";
      msg.value = "";
      msg.focus();
    });
    socket.on('count', count => {
      cnt.innerText = count;
    });

    socket.on('stream', (stream) => {
      // console.log(stream);
      document.getElementById('videoout').src = stream;
    });
  </script>
</body>

</html>